#!/bin/bash

set -e

function real_path {
    [[ ${1} = /* ]] && echo "${1}" || echo "${PWD}/${1#./}"
}

# Parameters
recipe=${1:-default}

# Get ready
runlist="recipe[jarbas::osx_sudoers_nopass],recipe[jarbas::${recipe}],recipe[jarbas::osx_sudoers]"
json='{"jarbas":{"home": "'"${HOME}"'", "user":"'"${USER}"'"}}'

# Use local settings if found
if [ -f ~/jarbas_node_data.json ]; then
    json=$(cat ~/jarbas_node_data.json)
fi

sudo -v
pushd $(dirname $(dirname $(real_path $0)))

# Chef if update is required
if [ ! -d berks-cookbooks ]; then
    bin/update
fi

# Run chef
echo ${json} | sudo chef-client -z -o "${runlist}" -j /dev/stdin -c .chef/client.rb --chef-license accept

# Tidy up
popd
